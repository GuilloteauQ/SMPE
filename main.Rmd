---
title: "SMPE"
author: "Quentin Guilloteau"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
knitr::opts_chunk$set(echo = TRUE)
```

1. Réalisez un graphique qui vous montrera une oscillation périodique superposée à une évolution systématique plus lente.

2. Séparez ces deux phénomènes. Caractérisez l'oscillation périodique. Proposez un modèle simple de la contribution lente, estimez ses paramètres et tentez une extrapolation jusqu'à 2025 (dans le but de pouvoir valider le modèle par des observations futures).

# Downloading the data

```{r}
# Downloading the data
csv_url <- "https://scrippsco2.ucsd.edu/assets/data/atmospheric/stations/in_situ_co2/weekly/weekly_in_situ_co2_mlo.csv"
df <- read.csv(csv_url, sep = ",", comment.char = "\"", blank.lines.skip=TRUE, strip.white=TRUE, skip=44, header=FALSE)

# Naming the columns
colnames(df) <- c("date", "CO2")

# A quick look at the data
head(df)
sapply(df, typeof)

# Checking if there are NAs in the data
na_lines <- apply(df, 1, function(x) any(is.na(x)))
df[na_lines,]
```
# Managing the dates

As the ``date`` column is considered as ``integer``, we will convert it into a date.

```{r}
df$date <- as.Date(df$date)
sapply(df, class)
```

# Plotting some stuff

We can now plot the CO2 evolution in ppm from 1958:
```{r}
ggplot(data = df, aes(x = date, y = CO2)) +
    geom_point(size = 0.1)
```

We can see that there seems to be a periodical oscillation but also the global trend is increasing.

# Regression for global trend

## Setting up the Data

Instead of using pure dates, we will convert each date into the number of days since the first measurement of the data set
```{r}
date_first_measure <- df$date[1]
df$day <- as.integer(df$date - date_first_measure)
```

## Linear Regression

We can try to fit a line for the CO2 concentration:

```{r}
# Linear Regression
reg_line <- lm(data = df, CO2 ~ day)
summary(reg_line)
```

We can plot the estimation of this model:

```{r}
# Compute the predictions
df$prediction_line <- predict(reg_line, df)
# Plot the data and the predictions
ggplot(data = df, aes(x = date, y = CO2)) +
    theme_linedraw() +
    geom_point(size = 0.1) +
    geom_line(aes(x = date, y = prediction_line), colour = "blue") +
    xlab("Date") + ylab("CO2 (in ppm)") +
    ggtitle("CO2 Variations and its Linear Estimation")
```

We can see that even if the $R^2$ value in the summary was close to 1, a line does not seems to be a good fit for this data.

Indeed:

* it is underestimating from year 1958 to 1970

* it is overestimating from yaer 1970 to 2005

* it is underestimating from year 2005 to the present days

## Quadratic Regression

As we saw previously, a line is not a good fit to model the data.

Let us try with a polynom of degree 2: $CO2(day) = a \times day^2 + b \times day + c$.

We can use the function ``poly`` to quickly generate of polynom.

```{r}
reg_quad <- lm(data = df, CO2 ~ poly(day, 2))
summary(reg_quad)
```

We can now plot the data and the predictions:

```{r}
df$prediction_quad <- predict(reg_quad, df)
ggplot(data = df, aes(x = date, y = CO2)) +
    theme_linedraw() +
    geom_point(size = 0.1) +
    geom_line(aes(x = date, y = prediction_quad), colour = "blue") +
    # scale_y_continuous(limits = c(0, 450)) +
    xlab("Date") + ylab("CO2 (in ppm)") +
    ggtitle("CO2 Variations and its Quadratic Estimation")
```

The quadratic model fits way more the data.

## CO2 Prediction for 2025

An estimation in 2025:

```{r}
# January, 1st 2025
date_2025 <- as.Date("2025-01-01")
day_2025 <- as.integer(date_2025 - date_first_measure)

# Current date
date_today <- Sys.Date()
day_today <- as.integer(date_today - date_first_measure)

# Creating points to estimate
data_prediction <- data.frame(day = seq(day_today, day_2025, 7))
data_prediction$date <- as.Date(date_first_measure + data_prediction$day)
# Predicting the CO2 Concentration
data_prediction$CO2 <- predict(reg_quad, data_prediction)

ggplot() +
    theme_linedraw() +
    geom_point(data = df, aes(x = date, y = CO2), size = 0.1) +
    geom_line(data = data_prediction, aes(x = date, y = CO2), color = "red") + 
    scale_y_continuous(limits = c(0, 450)) +
    xlab("Date") + ylab("CO2 (in ppm)") +
    ggtitle("CO2 Variations to the Present Day and its Estimation until 2025")
```

We can say that if the CO2 concentration in the air continues to follow this quadratic grow, the concentration of CO2 in the air in 2025 will be around 425 ppm.

# Yearly Evolution

We will add a column in our data frame to indicate the which day of the year this is January 1st being day 0 and December 31st being 365.
This will help us compare each year.

```{r}
df$year <- as.integer(format(df$date, "%Y"))
df$day_of_year <- as.integer(df$date - as.Date(paste(df$year, "01", "01", sep = "-")))
```

We also want to look at the variations of CO2 in the year during the year.
So we will substract the value of the first measure of the year for every measure of this year.

```{r}
df$CO2_year <- 0
for (y in df$year) {
  first_CO2_value_of_the_year <- df[df$year == y,]$CO2[1]
  df[df$year == y,]$CO2_year <- df[df$year == y,]$CO2 - first_CO2_value_of_the_year
}
```


We can plot the yearly evolution of some years:
```{r}
ggplot(data = subset(df, year == 1960 | year == 1997 | year == 2019), 
       aes(x = day_of_year, y = CO2_year, color = factor(year))) +
    theme_linedraw() +
    geom_line() +
    scale_y_continuous(limits = c(-5, 5)) +
    xlab("Day of the Year") + ylab("CO2 Variation (in ppm)") +
    ggtitle("CO2 Variations for the Years 1960, 1997 and 2019")
```

# Regression for a yearly trend

```{r}
degree <- 5
reg_poly <- lm(data = df, CO2_year ~ poly(day_of_year, degree) + poly(year, 2))
summary(reg_poly)
```

```{r}
df$prediction_poly <- predict(reg_poly, df)

ggplot(data = df[df$year == 2019,]) +
    theme_linedraw() +
    geom_point(aes(x = day_of_year, y = CO2_year)) +
    geom_line(aes(x = day_of_year, y = prediction_poly)) +
    scale_y_continuous(limits = c(-5, 5)) +
    xlab("Days of the Year") + ylab("CO2 Variation (in ppm)") +
    ggtitle("CO2 Variations and its Polynimial Prediction for the Year 1997 (in ppm)")
```

## Trying with a sin

Let us try to fit a sinusoidal curve for the oscilations over one year.
We decide to add a polynomial expression to represent the global evolution over the year.
```{r}
reg_sin <- lm(data = df, CO2_year ~ sin(2 * pi * day_of_year / 366) +
                                    cos(2 * pi * day_of_year / 366) +
                                    poly(day_of_year, 2) +
                                    poly(year, 2))
summary(reg_sin)
```

```{r}

df$prediction_sin <- predict(reg_sin, df)

ggplot(data = df[df$year == 1997,]) +
    theme_linedraw() +
    geom_point(aes(x = day_of_year, y = CO2_year)) +
    geom_line(aes(x = day_of_year, y = prediction_sin)) +
    scale_y_continuous(limits = c(-5, 5)) +
    xlab("Days of the Year") + ylab("CO2 Variation (in ppm)") +
    ggtitle("CO2 Variations and its Sin Prediction for the Year 1997 (in ppm)")
```
